<template>
  <div id="map"></div>
</template>

<script>
import L from 'leaflet';
import { antPath } from 'leaflet-ant-path';
import Wkt from 'wicket';

let osm = {};

export default {
  data() {
    return {
      currentLatitude: null,
      currentLongitude: null,
    };
  },
  methods: {
    setMap(lat = 25.05, lng = 121.55) {
      // 設定地圖初始狀態
      osm = L.map('map', {
        center: [lat, lng],
        zoom: 13,
      });

      // 匯入圖資(此範例使用 openstreetmap)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png?{foo}', {
        foo: 'bar',
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(osm);

      const markerIcon = new L.Icon({
        iconUrl: 'my-icon.png',
        iconSize: [38, 95],
        iconAnchor: [22, 94],
        popupAnchor: [-3, -76],
        shadowUrl: 'my-icon-shadow.png',
        shadowSize: [68, 95],
        shadowAnchor: [22, 94],
      });

      const polyLineArr = [];

      // 設定座標
      for (let i = 0; i < 10; i++) {
        const point = i / 100;
        const latlng = [lat + point, lng + point];
        polyLineArr.push(latlng);

        L.marker(latlng, { icon: markerIcon })
          .addTo(osm)
          .bindPopup(`<h3>目前位置</h3>`);

        // L.marker([lat, lng], { icon: markerIcon })
        //   .addTo(osm)
        //   .bindPopup(`<h3>目前位置</h3>`)
        //   .openPopup();
      }

      // marker太多時,可使用 leaflet MarkerCluster 額外插件處理效能問題

      // 繪製線圖（單純線圖）
      // const polyline = L.polyline(polyLineArr, { color: 'red' }).addTo(osm);
      // osm.fitBounds(polyline.getBounds());

      // 繪製線路圖（leaflet ant path）
      // GEO 目前為死資料
      const GEO =
        'LINESTRING(121.20703 24.91336,121.20898 24.91346,121.21039 24.91363,121.21091 24.91192,121.21139 24.91009,121.21142 24.90968,121.21132 24.90874,121.21134 24.90832,121.21181 24.90718,121.21185 24.90688,121.21168 24.90530,121.21178 24.90316,121.21176 24.90286,121.21086 24.89977,121.21080 24.89945,121.21081 24.89898,121.21114 24.89661,121.21129 24.89542,121.21147 24.89423,121.21211 24.89261,121.21228 24.89211,121.21261 24.88964,121.21234 24.88657,121.21192 24.88323,121.21174 24.88180,121.21169 24.88118,121.21165 24.87833,121.21173 24.87797,121.21187 24.87770,121.21238 24.87696,121.21295 24.87612,121.21323 24.87558,121.21354 24.87438,121.21363 24.87397,121.21372 24.87132,121.21381 24.86954,121.21401 24.86947,121.21621 24.86721,121.21830 24.86829,121.21972 24.86901,121.22016 24.86919,121.22046 24.86919,121.22062 24.86914,121.22077 24.86901,121.22097 24.86877,121.22195 24.86679,121.22242 24.86542,121.22271 24.86436,121.22291 24.86332,121.22305 24.86228,121.22309 24.86164,121.22311 24.86117,121.22305 24.86081,121.22295 24.86054,121.22277 24.86032,121.22261 24.86021,121.22236 24.86016,121.22215 24.86019,121.22191 24.86034,121.22182 24.86049,121.22178 24.86069,121.22183 24.86087,121.22196 24.86106,121.22217 24.86121,121.22262 24.86136,121.22412 24.86172,121.22496 24.86179,121.22538 24.86182,121.22586 24.86196,121.22633 24.86213,121.22731 24.86256,121.22846 24.86297,121.23018 24.86354,121.23122 24.86395,121.23199 24.86426,121.23305 24.86478,121.23405 24.86533,121.23482 24.86575,121.23621 24.86678,121.23799 24.86825,121.23901 24.86924,121.23980 24.87010,121.24106 24.87147,121.24234 24.87283,121.24340 24.87399,121.24445 24.87497,121.24563 24.87587,121.24675 24.87667,121.24775 24.87725,121.24958 24.87816,121.25065 24.87866,121.25174 24.87913,121.25341 24.87987,121.25510 24.88071,121.25579 24.88110,121.25664 24.88164,121.25795 24.88256,121.25873 24.88319,121.25950 24.88391,121.26028 24.88469,121.26104 24.88564,121.26187 24.88672,121.26232 24.88743,121.26270 24.88805,121.26314 24.88887,121.26572 24.89454,121.26657 24.89611,121.26710 24.89697,121.26763 24.89778,121.26818 24.89854,121.26897 24.89956,121.26973 24.90040,121.27107 24.90177,121.27243 24.90294,121.27318 24.90354,121.27453 24.90449,121.27601 24.90538,121.27697 24.90586,121.27792 24.90625,121.27904 24.90662,121.28103 24.90709,121.28502 24.90777,121.28685 24.90820,121.28804 24.90859,121.28941 24.90929,121.29059 24.91007,121.29150 24.91083,121.29195 24.91125,121.29268 24.91210,121.29301 24.91253,121.29344 24.91317,121.29381 24.91381,121.29559 24.91724,121.29642 24.91856,121.29744 24.91986,121.29867 24.92106,121.30009 24.92216,121.30107 24.92276,121.30229 24.92342,121.30494 24.92466,121.30614 24.92525,121.30737 24.92593,121.30840 24.92656,121.30969 24.92747,121.31073 24.92838,121.31169 24.92931,121.31288 24.93059,121.31571 24.93383,121.31695 24.93508,121.31764 24.93569,121.31903 24.93676,121.31995 24.93732,121.32102 24.93787,121.32215 24.93836,121.32333 24.93878,121.32443 24.93908,121.32569 24.93932,121.32670 24.93945,121.32802 24.93953,121.32968 24.93948,121.33033 24.93942,121.33126 24.93927,121.33224 24.93909,121.33344 24.93881,121.33464 24.93848,121.33640 24.93790,121.33939 24.93684,121.34236 24.93581,121.34342 24.93548,121.34438 24.93525,121.34526 24.93503,121.34624 24.93485,121.34707 24.93474,121.34791 24.93465,121.34878 24.93460,121.34983 24.93461,121.35063 24.93465,121.35164 24.93477,121.35236 24.93491,121.35347 24.93517,121.35437 24.93545,121.35499 24.93567,121.35608 24.93613,121.35724 24.93675,121.35792 24.93716,121.35862 24.93764,121.35981 24.93853,121.36086 24.93945,121.36283 24.94135,121.36480 24.94328,121.36567 24.94409,121.36700 24.94519,121.36795 24.94590,121.36889 24.94656,121.36985 24.94718,121.37196 24.94836,121.37307 24.94889,121.37418 24.94936,121.37598 24.95005,121.37753 24.95053,121.37913 24.95093,121.38020 24.95116,121.38129 24.95135,121.38251 24.95153,121.38457 24.95170,121.38594 24.95175,121.38741 24.95174,121.38907 24.95169,121.39084 24.95154,121.40085 24.95067,121.40461 24.95033,121.40826 24.95003,121.40959 24.94999,121.41092 24.95005,121.41189 24.95018,121.41276 24.95038,121.41390 24.95074,121.41455 24.95102,121.41548 24.95151,121.41640 24.95214,121.41726 24.95287,121.41762 24.95325,121.41847 24.95422,121.41926 24.95519,121.42032 24.95631,121.42105 24.95691,121.42168 24.95735,121.42233 24.95778,121.42318 24.95821,121.42414 24.95861,121.42491 24.95887,121.42563 24.95907,121.42702 24.95926,121.42784 24.95932,121.42830 24.95931,121.42883 24.95918,121.42952 24.95890,121.43002 24.95865,121.43046 24.95852,121.43074 24.95849,121.43114 24.95854,121.43134 24.95864,121.43166 24.95885,121.43194 24.95916,121.43210 24.95949,121.43231 24.96065,121.43252 24.96136,121.43267 24.96198,121.43273 24.96293,121.43286 24.96386,121.43286 24.96436,121.43278 24.96481,121.43288 24.96516,121.43312 24.96536,121.43331 24.96539,121.43474 24.96570,121.43504 24.96584,121.43570 24.96632,121.43614 24.96590)';
      // 'MULTILINESTRING ((120.53753502458 24.2453822428518,120.537486079662 24.2451762037051,120.5374639434 24.2450698188598,120.537453215843 24.2450245685574,120.537446515029 24.244971375864,120.53740896337 24.2446565075466,120.537376102648 24.2443379605712,120.537341234031 24.2440273621041,120.53731977794 24.2439099728286,120.537311732322 24.2437167618785,120.53724869941 24.2433603092558,120.537228588191 24.2432141844421,120.537219199112 24.2431365327659,120.537214503482 24.2430980093987,120.537210479645 24.2430588831248,120.537190360363 24.2428687324115,120.53717091859 24.2426736899826,120.537148113792 24.2424719196718,120.537139404682 24.2423832635854,120.537125318907 24.2422701493832))';
      // 'MULTILINESTRING ((121.507844929867 25.0305406081598,121.508198971795 25.0303170264937,121.508853437046 25.0297240234826,121.509352330098 25.0292233848301,121.509861944256 25.0287907797434))';

      const wkt = new Wkt.Wkt();
      // const geoArr = wkt.read(GEO).toJson().coordinates[0].map(itm => itm.reverse());
      const geoArr = wkt
        .read(GEO)
        .toJson()
        .coordinates.map((itm) => itm.reverse());
      console.log(geoArr);
      const path = antPath(geoArr, {
        delay: 400,
        dashArray: [10, 20],
        weight: 5,
        color: '#0000FF',
        pulseColor: '#FFFFFF',
        paused: false,
        reverse: false,
        hardwareAccelerated: true,
        opacity: 0.5,
      });
      osm.addLayer(path);
      osm.fitBounds(path.getBounds());
    },
  },
  mounted() {
    if ('geolocation' in window.navigator) {
      /* geolocation is available */
      window.navigator.geolocation.getCurrentPosition(
        (position) => {
          // 用戶同意定位
          this.currentLatitude = position.coords.latitude;
          this.currentLongitude = position.coords.longitude;
          this.setMap(this.currentLatitude, this.currentLongitude);
        },
        () => {
          // 用戶拒絕定位
          this.setMap();
        }
      );
    } else {
      /* geolocation is NOT available */
      this.setMap();
    }
  },
};
</script>

<style lang="scss" scoped>
#map {
  height: 100vh;
}
</style>
